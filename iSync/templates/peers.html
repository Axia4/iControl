{% extends "_base.html" %}

{% block title %}Gestión de Peers - iSync{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-white mb-4">
            <i class="fas fa-network-wired"></i> Gestión de Peers
        </h1>
    </div>
</div>

<!-- Add New Peer -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-plus"></i> Conectar Nuevo Peer</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{{ url_for('connect_peer') }}">
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <label for="peer_url" class="form-label">URL del Peer</label>
                            <input type="url" class="form-control" id="peer_url" name="peer_url" 
                                   placeholder="https://ejemplo.com:5342" required>
                            <div class="form-text">Introduce la URL completa del peer iSync (ej: https://peer.ejemplo.com:5342)</div>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-link"></i> Conectar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Connected Peers -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle"></i> Peers Conectados 
                    <span class="badge bg-light text-dark">{{ connected_peers|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if connected_peers %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Node ID</th>
                                    <th>Conectado desde</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for peer_id, peer_info in connected_peers.items() %}
                                <tr>
                                    <td>
                                        <code>{{ peer_id[:16] }}...</code>
                                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('{{ peer_id }}')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                    <td>
                                        {% if peer_info.connected_at %}
                                            {% set connected_time = peer_info.connected_at %}
                                            {% set now = (peer_info.connected_at or 0) %}
                                            Hace unos minutos
                                        {% else %}
                                            Desconocido
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-success">
                                            <i class="fas fa-circle"></i> Conectado
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="syncWithPeer('{{ peer_id }}')">
                                            <i class="fas fa-sync"></i> Sincronizar
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                        <h5>No hay peers conectados</h5>
                        <p>Conecta peers para comenzar la sincronización de datos.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Saved Peers -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-bookmark"></i> Peers Guardados 
                    <span class="badge bg-light text-dark">{{ saved_peers|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if saved_peers %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>URL</th>
                                    <th>Agregado</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for peer_id, peer_data in saved_peers.items() %}
                                <tr>
                                    <td>
                                        <a href="{{ peer_data.url }}" target="_blank" class="text-decoration-none">
                                            {{ peer_data.url }}
                                            <i class="fas fa-external-link-alt ms-1"></i>
                                        </a>
                                    </td>
                                    <td>
                                        {% if peer_data.added_at %}
                                            {{ peer_data.added_at[:19] if peer_data.added_at else 'Desconocido' }}
                                        {% else %}
                                            Desconocido
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-clock"></i> {{ peer_data.status or 'saved' }}
                                        </span>
                                    </td>
                                    <td>
                                        <form method="post" action="{{ url_for('connect_peer') }}" class="d-inline">
                                            <input type="hidden" name="peer_url" value="{{ peer_data.url }}">
                                            <button type="submit" class="btn btn-sm btn-primary">
                                                <i class="fas fa-link"></i> Conectar
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-bookmark fa-3x mb-3"></i>
                        <h5>No hay peers guardados</h5>
                        <p>Los peers que agregues se guardarán aquí para conexiones futuras.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Available Peers from Discovery -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-globe"></i> Peers Disponibles (Descubrimiento) 
                    <span class="badge bg-dark">{{ available_peers|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if available_peers %}
                    <div class="row">
                        {% for peer in available_peers %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card border">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        {{ peer.get('name', 'Peer sin nombre') }}
                                        {% if peer.get('verified') %}
                                            <i class="fas fa-shield-alt text-success" title="Peer verificado"></i>
                                        {% endif %}
                                    </h6>
                                    <p class="card-text">
                                        <small class="text-muted">{{ peer.get('url', '') }}</small>
                                    </p>
                                    {% if peer.get('description') %}
                                    <p class="card-text">
                                        <small>{{ peer.get('description') }}</small>
                                    </p>
                                    {% endif %}
                                    {% if peer.get('location') %}
                                    <p class="card-text">
                                        <small><i class="fas fa-map-marker-alt"></i> {{ peer.get('location') }}</small>
                                    </p>
                                    {% endif %}
                                    <form method="post" action="{{ url_for('connect_peer') }}">
                                        <input type="hidden" name="peer_url" value="{{ peer.get('url', '') }}">
                                        <button type="submit" class="btn btn-sm btn-primary w-100">
                                            <i class="fas fa-link"></i> Conectar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h5>No se pudieron cargar peers</h5>
                        <p>No se pudo conectar al servidor de descubrimiento de peers.</p>
                        <button onclick="location.reload()" class="btn btn-outline-primary">
                            <i class="fas fa-refresh"></i> Reintentar
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show a temporary toast
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = '<i class="fas fa-check"></i> Node ID copiado al portapapeles';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    });
}

function syncWithPeer(peerId) {
    // Trigger sync with specific peer
    socket.emit('request_sync', { target_peer: peerId });
    
    // Show feedback
    const toast = document.createElement('div');
    toast.className = 'alert alert-info position-fixed top-0 end-0 m-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `<i class="fas fa-sync"></i> Sincronización solicitada con ${peerId.substring(0, 8)}...`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Auto-refresh page every 60 seconds to update peer status
setInterval(function() {
    if (document.visibilityState === 'visible') {
        location.reload();
    }
}, 60000);
</script>
{% endblock %}
